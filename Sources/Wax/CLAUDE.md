# Sources/Wax Module

## Purpose
The `Wax` target is the high-level API layer that sits on top of `WaxCore`. It provides domain-specific orchestrators (PhotoRAG, VideoRAG, PDF ingest), the unified search engine, the FastRAG context builder, and all public protocols/types that host apps consume directly.

## Key Types

| Type | Role |
|------|------|
| `PhotoRAGOrchestrator` | Actor. Ingests PHAssets offline-only, extracts metadata/OCR/embeddings, serves hybrid recall with pixel payloads. |
| `VideoRAGOrchestrator` | Actor. Ingests local/Photos videos, segments into keyframe windows, indexes transcripts, returns grouped video context. |
| `FastRAGContextBuilder` | Struct. Deterministic context assembly: expansion + surrogates + snippets under a strict token budget. |
| `MemoryOrchestrator` | Higher-level orchestrator for general text memory (also hosts PDF ingest via extension). |
| `UnifiedSearch` | Extension on `Wax` (in WaxCore). Fuses BM25, vector, temporal, and structured-evidence lanes with query-type-adaptive weights. |
| `MultimodalEmbeddingProvider` | Protocol. Host-supplied text+image embedder in a shared embedding space. |
| `OCRProvider` / `CaptionProvider` | Protocols. Host-supplied or default (VisionOCRProvider) on-device providers. |
| `VideoTranscriptProvider` | Protocol. Host-supplied transcript generation; Wax does not transcribe in v1. |

## Architecture Patterns

- **Actor isolation**: `PhotoRAGOrchestrator` and `VideoRAGOrchestrator` are both actors. All mutable index state is actor-isolated.
- **Protocol-driven providers**: Embedding, OCR, caption, and transcript providers are all protocols with `Sendable` conformance and `ProviderExecutionMode` for on-device enforcement.
- **Frame hierarchy**: Both Photo and Video RAG use a root + derived frames pattern. Root frames hold metadata/embeddings; child frames hold OCR blocks, captions, tags, regions, or segment data.
- **Supersede-not-delete**: Re-ingesting an asset supersedes the old root rather than deleting it. Superseded frames are filtered out during indexing and retrieval.
- **Capture-time semantics**: Frames are written with the media's capture timestamp (not ingest time), enabling temporal queries that align with real-world chronology.
- **Deterministic retrieval**: Token counting uses cl100k_base; tie-breaks are deterministic (score > frameId); context budgets are strict.

## Concurrency Model

- Orchestrators are actors; internal state mutations are serialized.
- Suspension points (metadata loading, embedding, OCR) interleave across assets within throttled task groups.
- `WaxSession` handles index staging/commit lifecycle; the orchestrator calls `session.commit()` after batch writes.
- Query embedding caches (`EmbeddingMemoizer`) are actor-safe.

## Dependencies

- `WaxCore` (the `.mv2s` file engine: `Wax` actor, frame storage, WAL, TOC)
- `WaxTextSearch` (BM25/FTS5 search engine)
- `WaxVectorSearch` (vector search engines, `VectorEnginePreference`, `EmbeddingIdentity`)
- `Foundation`, `CoreGraphics`, `ImageIO`, `UniformTypeIdentifiers`
- Platform-conditional: `Photos`, `CoreLocation`, `AVFoundation`, `Vision`, `PDFKit`

## Key Conventions

- All public types are `Sendable`.
- Metadata keys are namespaced strings (e.g., `photo.location.lat`, `video.segment.start_ms`).
- Frame kinds follow a dot-separated hierarchy: `photo.root`, `photo.ocr.block`, `video.segment`, etc.
- Normalized rects use top-left origin in `[0, 1]` coordinates.
- Location binning uses `Int(floor(coordinate * 100.0))` for ~1km resolution.

## Common Pitfalls

- `MultimodalEmbeddingProvider.normalize` must be `true` when using Metal vector search; the orchestrator validates this at init.
- `ProviderExecutionMode` defaults to `.onDeviceOnly` via protocol extensions; override only if provider truly needs network.
- `syncLibrary` fetches asset IDs on `@MainActor` then passes them to the actor; do not call Photos APIs inside the actor directly.
- PDF extraction is `#if canImport(PDFKit)` gated; non-Apple platforms will not compile PDF ingestion.


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 9, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #1687 | 5:11 AM | ðŸ”µ | Wax.swift Serves as Unified Module Export | ~258 |
</claude-mem-context>