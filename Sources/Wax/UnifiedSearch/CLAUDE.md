# Sources/Wax/UnifiedSearch Module

## Purpose
Implements unified hybrid search over the Wax store. A single `SearchRequest` fuses results from multiple search lanes (BM25 text, vector similarity, timeline, structured memory evidence) using Reciprocal Rank Fusion (RRF) with query-type-adaptive weights.

## Key Types

| Type | Role |
|------|------|
| `Wax.search(_:)` | Public extension method. Entry point for all searches. |
| `SearchRequest` | Struct. Query parameters: text, embedding, mode (hybrid/textOnly/vectorOnly), topK, filters, time range, structured memory options. |
| `SearchResponse` | Struct. Results with frame IDs, scores, preview text, and source attribution. |
| `SearchMode` | Enum. `.textOnly`, `.vectorOnly`, `.hybrid(alpha:)`. Alpha blends text vs vector weight. |
| `FrameFilter` | Struct. Optional frame ID allowlist, include/exclude flags for deleted/superseded/surrogates. |
| `RuleBasedQueryClassifier` | Classifies queries into `QueryType` (factual, temporal, exploratory, etc.) for adaptive fusion. |
| `AdaptiveFusionConfig` | Provides per-query-type weights for BM25, vector, and temporal lanes. |
| `UnifiedSearchEngineCache` | Shared cache for text/vector engine instances to avoid re-creation. |

## Search Pipeline

1. **Classify query** -- `RuleBasedQueryClassifier.classify()` determines `QueryType`.
2. **Select weights** -- `AdaptiveFusionConfig.default.weights(for:)` returns per-lane weights.
3. **Run lanes in parallel** -- Text (FTS5), vector, structured memory, and optionally timeline.
4. **Fuse results** -- `HybridSearch.rrfFusion()` with weighted RRF (configurable `rrfK`, default 60).
5. **Filter** -- Apply time range, frame allowlist, deleted/superseded exclusions, min score.
6. **Attach previews** -- Load preview text for results without FTS5 snippets.
7. **Timeline fallback** -- If no results and `allowTimelineFallback`, return recent frames by timestamp.

## Query Expansion

If the initial FTS5 search returns zero results, the query is OR-expanded: each token is quoted and joined with `OR`. This improves recall for multi-word queries where exact phrase matching fails.

## Structured Memory Lane

When `structuredMemory.weight > 0`, the search also resolves entity candidates from the query, looks up facts and evidence frames, and includes them in the RRF fusion with their own weight.

## Metadata Loading Optimization

For small result sets (<50 items), metadata is loaded lazily per-frame to avoid dictionary overhead. For larger sets, batch prefetch is used.

## Dependencies

- `WaxCore` (`Wax`, `FrameMeta`, `TimelineQuery`, `TimeRange`)
- `WaxTextSearch` (`FTS5SearchEngine`, `TextSearchResult`, `HybridSearch`)
- `WaxVectorSearch` (`VectorSearchEngine`, `MetalVectorEngine`, `VectorMath`)
- `Foundation`

## Common Pitfalls

- `candidateLimit` is 3x topK (capped at 1000) to ensure enough candidates survive filtering.
- `vectorOnly` mode throws if no embedding is provided.
- `allowTimelineFallback` should only be enabled for constraint-only queries (no text, no embedding).


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>