# Sources/Wax/RAG Module

## Purpose
The core RAG (Retrieval-Augmented Generation) pipeline for general text memory. Provides deterministic context assembly from Wax search results under strict token budgets.

## Key Types

| Type | Role |
|------|------|
| `FastRAGContextBuilder` | Struct. Deterministic RAG context builder. Produces `RAGContext` from a query + Wax store. |
| `FastRAGConfig` | Struct. Controls mode (fast/denseCached), token budgets, search params, tier selection policy. |
| `RAGContext` | Struct. Output: ordered items (expanded, surrogate, snippet) with total token count. |
| `SurrogateTier` | Enum. Compression tiers: `full`, `gist`, `micro`. |
| `TierSelectionPolicy` | Enum. Controls how surrogate tier is chosen: `disabled`, `ageOnly`, `importance`. |
| `AgeThresholds` | Struct. Time-based tier boundaries (recent/old days). |
| `ImportanceThresholds` | Struct. Score-based tier boundaries (full/gist thresholds). |
| `SurrogateTierSelector` | Struct. Evaluates `TierSelectionContext` to pick a tier. |
| `ImportanceScorer` | Struct. Combines age and access frequency into an importance score. |
| `QueryAnalyzer` / `QuerySignals` | Query-aware tier boosting (temporal queries, named entities). |

## Context Assembly Pipeline

1. **Unified Search** -- Run a single `SearchRequest` (hybrid/text/vector) via `wax.search()`.
2. **Expansion** -- First result with valid UTF-8 content is fully expanded up to `expansionMaxTokens`.
3. **Surrogates** (denseCached mode) -- Batch-resolve surrogate frames, select tier per frame, truncate to `surrogateMaxTokens`.
4. **Snippets** -- Remaining results contribute preview text truncated to `snippetMaxTokens`.
5. **Budget enforcement** -- All items are assembled under `maxContextTokens` total; items stop being added when the budget is exhausted.

## Tier Selection Policy

The `TierSelectionPolicy` determines which surrogate tier to use at retrieval time:
- **`disabled`** -- Always use `full` tier.
- **`ageOnly(AgeThresholds)`** -- Recent (<7d default) = full, mid-age = gist, old (>30d) = micro.
- **`importance(ImportanceThresholds)`** -- Combines age + access frequency via `ImportanceScorer`. Query-aware boosting optionally promotes tiers for specific query patterns.

## Determinism Guarantees

- Token counting uses `cl100k_base` via `TokenCounter.shared()`.
- Surrogate tier selection accepts an optional `deterministicNowMs` to fix the "now" timestamp.
- Items are ordered by search response order (RRF-fused, deterministic tie-breaks).
- Batch token operations use `countAndTruncateBatch` for consistency.

## Concurrency Model

- `FastRAGContextBuilder` is a `Sendable` struct with no mutable state.
- Surrogate metadata and contents are prefetched in parallel using `async let`.
- Tier selection runs in a `TaskGroup` for parallelism while preserving response order.

## Dependencies

- `WaxCore` (`Wax`, `WaxSession`, `TokenCounter`, `FrameMeta`)
- `WaxTextSearch` (`SearchMode`, `SearchRequest`)
- `WaxVectorSearch` (`VectorEnginePreference`)
- `Foundation`

## Common Pitfalls

- `expansionMaxBytes` caps raw payload size before UTF-8 decode; prevents OOM on large frames.
- Surrogate frames must have `kind == "surrogate"` and `source_frame_id` metadata; the surrogate index is lazily built and cached.
- If `mode == .fast`, surrogates are skipped entirely (only expansion + snippets).
- `clamp()` normalizes all config values to non-negative; callers don't need to validate inputs.


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>