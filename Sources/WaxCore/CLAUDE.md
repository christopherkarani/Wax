# Sources/WaxCore Module

## Purpose
The foundational storage engine for Wax. Manages the `.mv2s` single-file format: frame storage, append-only WAL (Write-Ahead Log), TOC (Table of Contents), two-phase indexing (stage + commit), crash-safe persistence, and all core data types.

## Key Types

| Type | Role |
|------|------|
| `Wax` | Actor. Primary handle for a `.mv2s` file. Holds file descriptor, lock, header, TOC, WAL, pending mutations, staged indexes. All mutable state is actor-isolated. |
| `WaxSession` | Manages a write session with index staging/commit lifecycle. Coordinates text and vector index builds. |
| `FrameMeta` | Struct. Per-frame metadata: id, timestamp, kind, status, parent, payload offset/length, checksums, compression, metadata entries, supersede chain. |
| `FrameMetaSubset` | Struct. Write-time frame options: kind, role, parentId, metadata. |
| `MV2SHeaderPage` | Struct. Dual-page header with generation counter for atomic updates. |
| `MV2STOC` | Struct. Table of Contents: frame array, index manifests, segment catalog. |
| `WALRingWriter` / `WALRingReader` | Ring-buffer WAL for crash-safe writes. Entries are `PutFrame`, `DeleteFrame`, `SupersedeFrame`, `PutEmbedding`. |
| `TokenCounter` | Shared utility. Deterministic token counting/truncation using cl100k_base. |
| `BlockingIOExecutor` | Serial dispatch queue for all file I/O operations. |
| `FDFile` / `FileLock` | Low-level file descriptor and file lock wrappers. |
| `WaxError` | Error enum. Covers all engine-level errors. |

## File Format (`.mv2s`)

```
[Header Page A (4KB)] [Header Page B (4KB)] [WAL Ring (configurable)] [Data Region...] [TOC] [Footer]
```

- **Dual header pages**: Alternating writes with generation counters for atomic header updates.
- **WAL ring buffer**: Append-only; entries are applied to the TOC at commit time.
- **Data region**: Frame payloads (with optional compression), lex index blobs, vec index blobs.
- **TOC + Footer**: Frame metadata array + index manifests. Footer contains generation, TOC hash, WAL committed sequence.

## Lifecycle

1. **Create**: `Wax.create(at:)` -- writes empty header, TOC, footer.
2. **Open**: `Wax.open(at:)` -- reads header, recovers TOC from footer, replays pending WAL.
3. **Put**: `wax.put(_:options:)` -- appends payload to data region, WAL entry to ring.
4. **Stage indexes**: `wax.stageLexIndexForNextCommit()` / `wax.stageVecIndexForNextCommit()`.
5. **Commit**: `wax.commit()` -- applies pending mutations to TOC, writes staged indexes, new TOC+footer, updates header.
6. **Close**: `wax.close()` -- auto-commits if dirty, releases file lock.

## Two-Phase Indexing

Indexes are built externally (by `WaxSession` or the host) and staged as serialized blobs:
- **Lex index**: FTS5/SQLite database bytes from `sqlite3_serialize`.
- **Vec index**: Binary vector index (flat or GPU-optimized).

At commit, staged blobs are appended to the data region and referenced in the TOC's segment catalog.

## Writer Lease

Only one writer at a time. `acquireWriterLease(policy:)` supports `.fail`, `.wait`, and `.timeout` policies. `WaxSession` uses this to coordinate exclusive write access.

## Concurrency Model

- `Wax` is an actor; all state access is serialized.
- `AsyncReadWriteLock` (opLock) provides read/write lock semantics for concurrent reads during commits.
- All file I/O runs on a dedicated `BlockingIOExecutor` (serial dispatch queue).
- WAL capacity is checked before each write; if exceeded, an auto-commit is attempted.

## Dependencies

- `Foundation` only (no platform frameworks).
- Internal: `SHA256Checksum`, `PayloadCompressor`, `WALEntryCodec`, `FooterScanner`.

## Common Pitfalls

- Embedding mutations require a staged vec index before commit; otherwise commit throws.
- The surrogate index is lazily built on first access and invalidated on commit.
- `putBatch` attempts a single mapped write for efficiency; falls back to sequential if WAL capacity is insufficient.
- Frame IDs are dense (0-based, monotonically increasing); gaps are not allowed.
- `repair: true` on open truncates trailing bytes past the last valid footer, preserving pending WAL payloads.


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>